<!doctype html> <html> <head> <meta charset=UTF-8 /> <meta http-equiv=Content-Type content="text/html"/> <title>/code - AsktheRelic.com</title> <link rel=alternate type="application/rss+xml" title="RSS 2.0" href="/code/feed/"/> <link rel=stylesheet media=screen href="/stylesheets/code.css?1472997830"/> <link rel=stylesheet href='/stylesheets/github.css?1472997830'/> <link rel="shortcut icon" href="/favicon.ico?1472997830"> <script src="https://code.jquery.com/jquery-1.12.4.js" integrity="sha256-Qw82+bXyGq6MydymqBxNPYTaUXXq7c8v3CwiYwLLNXU=" crossorigin=anonymous></script> <script src="https://code.jquery.com/ui/1.8.24/jquery-ui.min.js" integrity="sha256-UOoxwEUqhp5BSFFwqzyo2Qp4JLmYYPTHB8l+1yhZij8=" crossorigin=anonymous></script> </head> <body> <div id=container> <div id=container2> <div id=container1> <div id=left> <div id=left-header> <h2><a href="/code">/code - a blog</a></h2> </div> <div id=content> <div id=main_block> <div id=prose_block class=post> <a name=dynamic-fabric-commands-for-managing-cloud-servers /> <h2 class="blog.post_title"><a href="/2011/02/17/dynamic-fabric-commands-for-managing-cloud-servers/">Dynamic Fabric Commands For Managing Cloud Servers</a></h2> <small>February 17, 2011 at 11:07 PM</small> <span class=post-prose> <p>Fabric is a Python CLI tool for interacting with remote servers, that I&rsquo;ve been pushing at work the last few months. It&rsquo;s great for organizing simple tasks to run locally or remotely, this blog is <a href="https://github.com/askedrelic/asktherelic.com/blob/master/fabfile.py" title="My Fabric file">even being deployed using Fabric</a> currently! It&rsquo;s a great tool.</p> <p>The two main ideas of Fabric are that you have hosts and tasks you apply to those hosts. Fabric uses <code class=prettyprint>fabfile.py</code> as its default instruction file, similar to a Rakefile or makefile. From a command line, you can call multiple tasks on a host and they will get applied in the order you called them. Hosts can be defined staticly in the fabfile through a variety of methods, but this gets hard once you have multiple hosts that can change easily with cloud computing/VPS solutions. I found a straight foward way to handle this was to have a task which defines which host I want to use, then the actual task I want to run on that host; calling <code class=prettyprint>fab production task1</code> or <code class=prettyprint>fab staging task1</code> to run task1 on my production or staging server.</p> <p>This is great for 1-2 static servers, but becomes more work to manage when in a dynamic cloud based server environment. I wanted a better solution, but Fabric doesn&rsquo;t easily fit to this pattern. I found <a href="http://www.saltycrane.com/blog/2010/09/class-based-fabric-scripts-metaprogramming-hack/" title="Dynamic Functions with Fabric">dynamic tasks had been attempted before</a> before with Fabric and used that idea as a start. Here is what I came up with to create dynamic host tasks:</p> <pre class="highlight python"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c">### Before</span>
<span class="k">def</span> <span class="nf">prod</span><span class="p">():</span>
    <span class="s">"""HOST: prod"""</span>
    <span class="n">env</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s">'user@foo.com'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">staging</span><span class="p">():</span>
    <span class="s">"""HOST: staging"""</span>
    <span class="n">env</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s">'user@bar.com'</span><span class="p">]</span>

<span class="c">### After</span>
<span class="n">hosts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'prod'</span>    <span class="p">:</span> <span class="p">[</span><span class="s">'user@foo.com'</span><span class="p">],</span>
    <span class="s">'staging'</span> <span class="p">:</span> <span class="p">[</span><span class="s">'user@bar.com'</span><span class="p">],</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">_createHost</span><span class="p">(</span><span class="n">hostName</span><span class="p">,</span> <span class="n">hostList</span><span class="p">):</span>
    <span class="n">moduleObj</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">__name__</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">setHost</span><span class="p">():</span>
        <span class="n">env</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="n">hostList</span>
    <span class="c">#Doc string is readonly during creation?</span>
    <span class="n">setHost</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="s">'HOST: </span><span class="si">%</span><span class="s">s '</span> <span class="o">%</span> <span class="n">hostName</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">moduleObj</span><span class="p">,</span> <span class="n">hostName</span><span class="p">,</span> <span class="n">setHost</span><span class="p">)</span>

<span class="k">for</span> <span class="n">host</span><span class="p">,</span> <span class="n">hostList</span> <span class="ow">in</span> <span class="n">hosts</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
    <span class="n">_createHost</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">hostList</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">run</span><span class="p">(</span><span class="s">'ls'</span><span class="p">)</span>
</code></pre> <p>So when Fabric runs, each host task is added as a function on the Fabric module and available to call.</p> <p>Now my current blog server is hosted on Linode and a good portion of my work servers are on Linode as well. Linode has a decent JSON api, and <a href="https://github.com/tjfontaine/linode-python" title="Linode API">Python library</a> using that api, which I can use to used to get a list of all currently running Linode servers and their IPs. Extending my code above, you can get a dynamic list of your Linode servers in Fabric!</p> <pre class="highlight plaintext"><code>def _createHost(hostName, hostSize, hostList):
    moduleObj = sys.modules[__name__]
    def setHost():
        env.hosts = hostList
    #Doc string is readonly during creation?
    setHost.__doc__ = 'HOST: %sMB' % hostSize
    setattr(moduleObj, hostName, setHost)

def _generateLinodeHosts():
    sys.path.append('.')
    # Import api locally to hide from Fabric
    import api as linodeApi
    LINODE_KEY = "LINODE_KEY_GOES_HERE"
    linode = linodeApi.Api(LINODE_KEY)
    linodeList = [(x['LINODEID'],x['LABEL'], x['TOTALRAM']) for x in linode.linode_list()]
    for server in linodeList:
        ipList = linode.linode_ip_list(LinodeID=int(server[0]))
        publicIps = [x['IPADDRESS'] for x in ipList if x['ISPUBLIC']]
        _createHost(server[1], server[2], [publicIps[0]])
_generateLinodeHosts()

def test():
    run('ls')
</code></pre> <p>You will want to add caching around your Linode calls, otherwise every usage of Fabric will generate a dozen api calls and be incredibly slow. I used pickle in my production setup, to save the Linode server list until I wanted to refresh it. This idea could easily be ported to Amazon EC2 or Slicehost or any other cloud provider, so happy hacking!</p> <p>You can view all of this code on github <a href="https://gist.github.com/830616/">here</a>.</p> </span> </div> </div> <div class=hr></div> <div> <h4>Recent Articles</h4> <div class="post frontpage"> <span class=linkdate>21 Apr 2014 »</span> <a href="/2014/04/21/upgrading-my-dotfiles-to-symlinks/">Upgrading My Dotfiles To Symlinks</a> </div> <div class="post frontpage"> <span class=linkdate>08 Feb 2014 »</span> <a href="/2014/02/08/another-year-another-set-of-backups/">Another Year, Another Set Of Backups</a> </div> <div class="post frontpage"> <span class=linkdate>02 Dec 2013 »</span> <a href="/2013/12/02/practical-lessons-learned-from-testing/">Practical Lessons Learned From Testing</a> </div> <div class="post frontpage"> <span class=linkdate>20 Nov 2013 »</span> <a href="/2013/11/20/streaming-small-http-responses-with-python/">Streaming Small HTTP Responses with Python</a> </div> <div class="post frontpage"> <span class=linkdate>03 Nov 2013 »</span> <a href="/2013/11/03/an-exploration-in-selecting-things/">An Exploration In Selecting Things</a> </div> <div class="post frontpage"> <span class=linkdate>22 Aug 2013 »</span> <a href="/2013/08/22/the-birthday-surprise/">The Birthday Surprise</a> </div> <div class="post frontpage"> <span class=linkdate>05 Aug 2013 »</span> <a href="/2013/08/05/a-newer-branch/">A Newer Branch</a> </div> </div> </div> <div class=hr></div> <p id=credits> Powered by <a href="http://middlemanapp.com/">Middleman</a>. <br/> <br/> </p> </div> <div id=right> <div id=right-header> <a href="/"><h1>Ask the Relic</h1></a> </div> </div> </div> </div> </div> <script>
  var _gaq = _gaq || [];
  _gaq.push(["_setAccount", "UA-1004202-1"]);
  _gaq.push(["_trackPageview"]);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script> </body> </html>