<!doctype html> <html> <head> <meta charset=UTF-8 /> <meta http-equiv=Content-Type content="text/html"/> <title>Streaming Small HTTP Responses with Python - AskTheRelic.com</title> <link rel=alternate type="application/rss+xml" title="RSS 2.0" href="/code/feed.xml"/> <link rel=stylesheet media=screen href="/stylesheets/code.css"/> <link rel=stylesheet href='/stylesheets/github.css'/> <link rel="shortcut icon" href="/favicon.ico"> <script src="https://code.jquery.com/jquery-1.12.4.js" integrity="sha256-Qw82+bXyGq6MydymqBxNPYTaUXXq7c8v3CwiYwLLNXU=" crossorigin=anonymous></script> <script src="https://code.jquery.com/ui/1.8.24/jquery-ui.min.js" integrity="sha256-UOoxwEUqhp5BSFFwqzyo2Qp4JLmYYPTHB8l+1yhZij8=" crossorigin=anonymous></script> </head> <body> <div id=container> <div id=container2> <div id=container1> <div id=left> <div id=left-header> <h2><a href="/code">/code - a blog</a></h2> </div> <div id=content> <div id=main_block> <div id=prose_block class=post> <a name=streaming-small-http-responses-with-python /> <h2 class="blog.post_title"><a href="/2013/11/20/streaming-small-http-responses-with-python/">Streaming Small HTTP Responses with Python</a></h2> <small>November 20, 2013 at 09:39 AM</small> <span class=post-prose> <p>For a recent hackathon project, I wanted to setup a client/server configuration, all in Python, so that the server could run shell commands and stream the output back to the client. The client was a Raspberry Pi and the server was my laptop, which already had my real project setup.</p> <p>My first thought was to do this over HTTP, with <a href="http://docs.python-requests.org/en/latest/index.html">Requests</a> for the client and <a href="http://bottlepy.org/docs/dev/">Bottle</a> for the server. I started writing some code, checked the Bottle docs for <a href="http://bottlepy.org/docs/dev/tutorial.html#generating-content">sending a streaming response</a>, and was running with a few lines.</p> <div class=highlight><pre class="highlight python"><code><span class="kn">import</span> <span class="nn">bottle</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="o">@</span><span class="n">bottle</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/stream'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">stream</span><span class="p">():</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">Popen</span><span class="p">(</span>
        <span class="s">'echo 1 &amp;&amp; sleep 3 &amp;&amp; echo 2 &amp;&amp; sleep 3 &amp;&amp; echo 3'</span><span class="p">,</span>
        <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">while</span> <span class="n">proc</span><span class="p">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">proc</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">output</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span>

<span class="n">bottle</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="n">bottle</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">reloader</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div> <p>This code worked great in Chrome; console output was streamed with pauses and the connection was not dropped.</p> <p>Then I started on a client in Python. Requests also <a href="http://docs.python-requests.org/en/latest/user/advanced/#streaming-requests">supports streaming responses</a>, just a parameter to the standard <code class=prettyprint>requests.get()</code>, nothing too major.</p> <div class=highlight><pre class="highlight python"><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://0.0.0.0:8000'</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">r</span><span class="p">.</span><span class="n">iter_lines</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">line</span>
</code></pre></div> <h3>The First Mistake</h3> <p>After running the client a few times, the output wasn&rsquo;t getting streamed. Output would pop in, as if the response was fully downloading before printing. I tried increasing the sleep amount, to see if the response was too short and tweaking the python handling of output, trying to find some sort of implicit stdout buffering with <code class=prettyprint>export PYTHONUNBUFFERED=True</code>. I rewrote the server in <a href="http://flask.pocoo.org/docs/">Flask</a>, which offers the same streaming capabilities as Bottle, but encountered the same situation with the client not streaming the response. After consulting with teammates, we couldn&rsquo;t see the problem and moved on to trying to stream a local SSH connection instead, which had its own host of environment problems.</p> <p>The one variable I didn&rsquo;t tweak in these examples was the response size, which seems obviously when looking back now. My first mistake was not testing boundary cases: all the minimum viable tests were extremely small and not extremely different. I moved on too quickly without diving deep enough into the problem: the docs and samples were all so simple, so I assumed nothing could be wrong with the libraries I&rsquo;m using.</p> <h3>The Second Mistake</h3> <p>This hackathon was all for fun, so I gave up and moved onto the next problem, but I returned the next day and dived deeper. My second mistake was trusting the docs: documentation is a great resource, but code never lies.</p> <p>After looking at the function declaration for the <a href="https://github.com/kennethreitz/requests/blob/v2.0.0/requests/models.py#L593"><code class=prettyprint>response.iter_lines()</code></a>, it quickly made sense: the default chunk size for the lines in the response was 512 bytes, which <code class=prettyprint>1 2 3</code> would never get chunked into multiple pieces. I was also not sending <code class=prettyprint>\r\n</code>, the standard <a href="http://en.wikipedia.org/wiki/Chunked_transfer_encoding">HTTP chunked terminator</a>.</p> <div class=highlight><pre class="highlight python"><code><span class="n">ITER_CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">512</span>
<span class="k">def</span> <span class="nf">iter_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">ITER_CHUNK_SIZE</span><span class="p">,</span> <span class="n">decode_unicode</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</code></pre></div> <p>Setting <code class=prettyprint>chunk_size=1</code> made my client immediately print output, solving all my problems.</p> <h3>For Next Time</h3> <p>To make testing easier, I&rsquo;ve created a Github repo to demo all this code: <a href="https://github.com/askedrelic/streaming-demo">https://github.com/askedrelic/streaming-demo</a>.</p> <p>While debugging this situation, I remembered to try HTTPie, <a href="https://github.com/jkbr/httpie">a cURL replacement written in Python using Requests</a>, which handled the streaming response correctly. Looking at HTTPie&rsquo;s code for consuming responses, led to me look at Request&rsquo;s code and figure everything out. Definitely recommend this tool!</p> <p>Lastly, always check the code and don&rsquo;t be afraid to dive deep.</p> </span> </div> </div> <div class=hr></div> <div> <h4>Recent Articles</h4> <div class="post frontpage"> <span class=linkdate>15 Jul 2024 »</span> <a href="/2024/07/15/connecting-apps-with-the-tailscale-kubernetes-operator-part-2/">Connecting Apps with the Tailscale Kubernetes Operator - Part 2</a> </div> <div class="post frontpage"> <span class=linkdate>23 Feb 2024 »</span> <a href="/2024/02/23/exploring-the-tailscale-kubernetes-operator-part1/">Exploring the Tailscale Kubernetes Operator - Part 1</a> </div> <div class="post frontpage"> <span class=linkdate>05 Feb 2024 »</span> <a href="/2024/02/05/quarterly-calendar-project/">Quarterly Calendar Project</a> </div> <div class="post frontpage"> <span class=linkdate>05 Jan 2024 »</span> <a href="/2024/01/05/joining-recurse-w2-2024/">Joining Recurse Center for W2 2024</a> </div> <div class="post frontpage"> <span class=linkdate>08 Jan 2017 »</span> <a href="/2017/01/08/hosting-with-dokku/">Hosting with Dokku</a> </div> <div class="post frontpage"> <span class=linkdate>18 Sep 2016 »</span> <a href="/2016/09/18/testing-the-layers-of-your-application-at-pyconuk-2016/">Testing the Layers of Your Application at PyConUK 2016</a> </div> <div class="post frontpage"> <span class=linkdate>21 Apr 2014 »</span> <a href="/2014/04/21/upgrading-my-dotfiles-to-symlinks/">Upgrading My Dotfiles To Symlinks</a> </div> </div> </div> <div class=hr></div> <p id=credits> Powered by <a href="https://middlemanapp.com/">Middleman</a>. <br/> <br/> </p> </div> <div id=right> <div id=right-header> <a href="/"><h1>Ask the Relic</h1></a> </div> </div> </div> </div> </div> </body> </html>